[gcode_macro _ajust_z_origin]
gcode:
    {% set z_offset = printer.configfile.settings['probe'].z_offset|float %}
    {% set nozzle_height = printer.probe.last_z_result|float - z_offset %}
    SET_KINEMATIC_POSITION Z={nozzle_height}

[gcode_macro M106]
gcode:
  M117 "M106: starting fan operation"

[homing_override]
axes: z
gcode:
    G90                                                    ; absolute moves

    # ── Conditionally home X/Y only when still un-homed ──
    {% set need_x = 'x' not in printer.toolhead.homed_axes %}
    {% set need_y = 'y' not in printer.toolhead.homed_axes %}

    {% if need_x and need_y %}
        G28 X Y                                            ; both were un-homed
    {% elif need_x %}
        G28 X                                              ; only X was un-homed
    {% elif need_y %}
        G28 Y                                              ; only Y was un-homed
    {% endif %}

    # ── Safe move to probe point (edit to taste) ─────────
    G0  X50 Y75 Z10 F6000

    # ── Probe and re-zero Z using your existing logic ────
    PROBE
    _ajust_z_origin                                        ; uses last_z_result

    G0 Z10      